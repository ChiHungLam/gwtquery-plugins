#summary How to use the drag-and-drop plugin with GWT widgets

DRAFT VERSION
<wiki:toc max_depth="3" />
= Introduction =
----
The draggable and droppable plugins of gwtquery allows to make any DOM elements draggable and droppable. In addition, it offers a API in order to add drag and drop support to your GWT widgets included also the new data presentation widgets (aka cell widgets).

This article explains how to use this API in your GWT project.

= Configuration =
----
!GwtQuery provides you a bundle including all stuff you need to use gwtquery and its draggable and dropable plugins

First at all, if you don't use maven, you have to download the [http://code.google.com/p/gwtquery-plugins/downloads/detail?name=gquery-dnd-bundle-1.0.1.jar gquery-dnd-bundle jar file] and include it in the classpath of you project.

If you use maven, you have to add these blocks to your pom.xml
{{{
   <repositories>
        <repository>
         <id>plugins</id>
         <url>http://gwtquery-plugins.googlecode.com/svn/mavenrepo</url>
       </repository>
   </repositories>

   <dependencies>
        <dependency>
            <groupId>com.googlecode.gwtquery.bundles</groupId>
            <artifactId>gquery-dnd-bundle</artifactId>
            <version>1.0.1</version>
            <scope>provided</scope>
        </dependency>
   </dependencies>
}}}

Then you need to inherit the plugin in your Module.gwt.xml file:
{{{
  <inherits name='gwtquery.plugins.droppable.Droppable'/>
}}}

Please note that the drag-and-drop plugin need at least GWT 2.1.0 to work.

= Add drag support to your widgets =
----

== The !DraggableWidget class ==
To make your widget draggable, you have two simple possibilities :
 * wrap your widget in a `DraggableWidget`instance 
 * extend you widget class with the `DraggableWidget`class.

Example with wrapping:
{{{

    Label label = new Label("I want to become a draggable widget !!");
    //wrap the original widget in a DraggableWidget
    DraggableWidget<Label> draggableLabel = new DraggableWidget<Label>(label);
    //configure the drag behavior (see next chapters)
    draggableLabel.setDraggingCursor(Cursor.MOVE);
    draggableLabel.setDraggingOpacity((float)0.8);
    
    ...
    
    //add the draggableLabel to the DOM
    RootPanel.get().add(draggableLabel);
    
    //if you want to do something in the original label, just call getOriginalWidget method
    draggableLabel.getOriginalWidget().setText("I'm now draggable");
}}}

Example with subclassing :

{{{
public class DraggableLabel extends DraggableWidget<Label> {

  public DraggableLabel() {
    //as DraggableWidget is a composite call initWidget() method to setup your widget
    initWidget(new Label("I'm a draggable label"));
    
    //configure the drag behavior (see next paragraphs)
    setDraggingCursor(Cursor.MOVE);
    setDraggingOpacity((float)0.8); 
  }

  public void setText(String text){
    getOriginalWidget().setText(text);
  }
}


}}}

== Configure the dragging behavior ==

The API of the `DraggableWidget` object proposes a set of methods allowing you to configure the drag behavior of your widget. You can find the list of all options and their related explanation in this [http://code.google.com/p/gwtquery-plugins/wiki/DraggablePluginGettingStarted#DraggableOptions_Object table]. 

An example is always more understandable than a long text of explanation :
{{{
    Label label = new Label("I want to be a droppable widget !!");
    //wrap the original widget in a DraggableWidget
    DraggableWidget<Label> draggableLabel = new DraggableWidget<Label>(label);
    
    //configure the drag behavior
    //use a clone of the helper as dragging display
    draggableLabel.useOriginalWidgetAsHelper();
    //change the cursor during the drag
    draggableLabel.setDraggingCursor(Cursor.MOVE);
    //set the opacity of the dragging display
    draggableLabel.setDraggingOpacity((float)0.8);
    // the widget can only be dragged on horizontal axis
    draggableLabel.setAxis(AxisOption.Y_AXIS);
    //revert the dragging display on its original position is not drop occured
    draggableLabel.setRevert(RevertOption.ON_INVALID_DROP);
    //snap the dragging display to a 50x50px grid
    draggableLabel.setGrid(new int[]{50,50});
    ...
}}}

Don't hesitate to try our [http://gwtquery-plugins.googlecode.com/svn/trunk/droppable/demo/TestOptionsSample/TestOptionsSample.html "options in action"] example to play around with most of the options of the `DraggableWidget`.

== The drag events ==
The drag-and-drop plugin fires different events during the drag operation that you can handle to implement your custom code.

Please find the list of drag events :
 * `gwtquery.plugins.draggable.client.events.BeforeDragStartEvent` : fired before the before the initialization of the drag operation
 * `gwtquery.plugins.draggable.client.events.DragStartEvent` : fired when the drag starts
 * `gwtquery.plugins.draggable.client.events.DragEvent` : fired durint the drag
 * `gwtquery.plugins.draggable.client.events.DragStopEvent` : fired when the drag operation stops

To handle an event, just register an associated event handler in your `DraggableWidget` :
{{{
    Label label = new Label("I want to be a droppable widget !!");
    //wrap the original widget in a DraggableWidget
    DraggableWidget<Label> draggableLabel = new DraggableWidget<Label>(label);
    
    draggableLabel.addDragStartHandler(new DragStartEventHandler() {
      
      public void onDragStart(DragStartEvent event) {
        //retrieve the widget that is being dragged
        DraggableWidget<Label> draggableWidget = (DraggableWidget<Label>)event.getDraggableWidget();
        draggableWidget.getOriginalWidget().setText("I'm dragging");
        
      }
    });
    
    draggableLabel.addDragStopHandler(new DragStopEventHandler() {
      
      public void onDragStop(DragStopEvent event) {
        //retrieve the widget that was being dragged
        DraggableWidget<Label> draggableWidget = (DraggableWidget<Label>)event.getDraggableWidget();
        draggableWidget.getOriginalWidget().setText("I'm not dragging");
        
      }
    });
}}}

All drag events provide useful method to retrieve the dragging widget and the associated dragging display (called the helper) excepted on the `BeforeDragStartEvent`where the helper is null because the drag operation is not initialized yet.


= Add drop support to your widgets =
----

== The !DroppableWidget class ==

In the same way, to make your widget droppable, you have two possibilities :
 * wrap your widget in a `DroppableWidget`instance 
 * extend you widget class with the `DroppableWidget`class

Example with wrapping:
{{{
    Label label = new Label("I want to be a droppable widget !!");
    //wrap the original widget in a DroppableWidget
    DroppableWidget<Label> droppableLabel = new DroppableWidget<Label>(label);
    //configure the drop behaviour (see next paragraph)
    droppableLabel.setTolerance(DroppableTolerance.POINTER);
    
    //add the droppableLabel to the DOM
    RootPanel.get().add(droppableLabel);
    
    //if you want to do something in the original label, just call getOriginalWidget method
    droppableLabel.getOriginalWidget().setText("I'm now droppable");
}}}

Example with subclassing :
{{{

 public class DroppableLabel extends DroppableWidget<Label> {

  public DroppableLabel() {
    //as DroppableWidget is a Composite, call initWidget() method to setup your widget
    initWidget(new Label("I'm a droppable label"));
    
    //configure the drop behavior (see next chapters)
    setTolerance(DroppableTolerance.POINTER);
   
  }
  
  public void setText(String text){
    getOriginalWidget().setText(text);
  }
}

}}}

== Configure the dropping behavior ==
The `DroppableWidget` API offers also a set of methods in order to configure the drop behavior of the widget. All available options are listed in the following [http://code.google.com/p/gwtquery-plugins/wiki/DroppablePluginGettingStarted#DroppableOptions_Object table].

Please refer to our [http://gwtquery-plugins.googlecode.com/svn/trunk/droppable/demo/TestOptionsSample/TestOptionsSample.html "options in action"] example to play around with most of the options of the `DroppableWidget`.

== The drop events ==
Different events are fired on the `DroppableWidget` during the drag-and-drop operation :
 * `gwtquery.plugins.droppable.client.events.DropEvent` : fired when a acceptable draggable (see next paragraph to know what an "acceptable draggable" is) is dropped on the `DroppableWidget`
 * `gwtquery.plugins.droppable.client.events.OutDroppableEvent` : fired when an acceptable draggable is being dragged out of the `DroppableWidget`
 * `gwtquery.plugins.droppable.client.events.OverDroppableEvent` : fired when an acceptable draggable is being dragged over the `DroppableWidget`
 * `gwtquery.plugins.droppable.client.events.ActivateDroppableEvent` : fired when the `DroppableWidget` is activate (when an acceptable draggable start to drag)
 * `gwtquery.plugins.droppable.client.events.DeactivateDroppableEvent` : fired when the `DroppableWidget` is deactivate (when an acceptable draggable stops to drag)

To handle an event, just register an associated event handler in your `DroppableWidget` :
{{{
    droppableLabel.addDropHandler(new DropEventHandler() {
      
      public void onDrop(DropEvent event) {
        // retrieve the droppable widget
        DroppableWidget<Label> droppableLabel = (DroppableWidget<Label>)event.getDroppableWidget();
        // retrieve the dropped draggable widget (we assume it is a draggable label)
        DraggableWidget<Label> draggableLabel = (DraggableWidget<Label>)event.getDraggableWidget();
        
        droppableLabel.getOriginalWidget().setText("I ate : "+draggableLabel.getOriginalWidget().getText());
        
        //remove the draggabeLable
        draggableLabel.removeFromParent();
        
      }
    });
     
}}}


= Scope and Accept options =
----

We will define what we mean by an "acceptable draggable".
 A draggable element is accepted by a droppable if and only if they have the same scope value and if true is returned when we call the `AcceptFunction` of the droppable by passing the draggable. When a draggable is accepted by the droppable, it can be drop on this last.

The scope options is a key used to group draggable and droppable items.

The Accept options is a kind of filter apply to group of draggable with the same scope as the droppable. 
It can be a css selector. All draggable matching this selector will be accepted :
{{{
   // all DraggableWidget with "draggableLabel" as css class name will be accepted
    droppableLabel.setAccept(".draggableLabel");
}}}

or an `AcceptFunction` object
{{{
    droppableLabel.setAccept(new AcceptFunction() {
      
      public boolean acceptDrop(DragAndDropContext context) {
        DraggableWidget<?> draggabelWidget = context.getDraggableWidget();
        //accept only draggable Label
        return draggabelWidget.getOriginalWidget() instanceof Label;

      }
      
    });
}}}

By default, the scope is defined to "default" and a droppable accepts all draggables with the same scope.

The [http://gwtquery-plugins.googlecode.com/svn/trunk/droppable/demo/DraughtsSample/DraughtsSample.html checker example] use a `AcceptFunction` to authorize drop of a piece in the authorized squares.

= The cell widgets =
----
Since its 2.1 release, GWT proposes a new kind of widget, the data presentation widgets and introduces the concept of cells.
The GWTQuery drag-and-drop plugins offers an API allowing to make any cell draggable and/or droppable.

== !DragAndDropCellList class ==

To add drag-and-drop support in a `CellList`, you have simply to use a `DragAndDropCellList` widget.
{{{
    // Create a ConcactCell (normal cell displaying info a a contact)
    ContactCell contactCell = new ContactCell(Images.INSTANCE.contact());

    // Create a drag and drop cell list
    DragAndDropCellList<ContactInfo> cellList = new DragAndDropCellList<ContactInfo>(
        contactCell, ContactDatabase.ContactInfo.KEY_PROVIDER);
    
    // The cell of this CellList are only draggable
    cellList.setCellDraggableOnly();
    
    // setup the drag operation
    DraggableOptions options = new DraggableOptions();
    // use a clone of the original cell as drag helper
    options.setHelper(HelperType.CLONE);
    // set the opacity of the drag helper
    options.setOpacity((float) 0.9);
    // append the drag helper to the body element
    options.setAppendTo("body");
    // configure the drag operations of the cell list with this options
    cellList.setDraggableOptions(options);

}}}

Look at the [http://gwtquery-plugins.googlecode.com/svn/trunk/droppable/demo/ContactCellSample/ContactCellSample.html contact cell example], to see a more concrete example in action.

== !DragAndDropCellTree, !DragAndDropCellBrowser and !DragAndDropNodeInfo classes==

In the same way, to add drag-and-drop in a `CellTree` (or a `CellBrowser`), just use a `DragAndDropCellTree` (or a `DragAndDropCellBrowser`) and use `DragAndDropNodeInfo` to define your tree model :

{{{
   DragAndDropCellTree cellTree = new DragAndDropCellTree(
        new MemberTreeViewModel(), null, DroppableCellTreeResource.INSTANCE);
   ...
     
   public class MemberTreeViewModel implements TreeViewModel {
    ...

    public <T> NodeInfo<?> getNodeInfo(T value) {

     if (value == null) {
      // permission tree node
      DragAndDropNodeInfo<Permission> permissionNodeInfo = new DragAndDropNodeInfo<Permission>(permissionDataProvider, permissionCell);
      
      // permission cell are only droppable
      permissionNodeInfo.setCellDroppableOnly();

      // setup drop operation
      DroppableOptions options = permissionNodeInfo.getDroppableOptions();
      options.setDroppableHoverClass(Resource.INSTANCE.css().droppableHover());
      // use a DroppableFunction to define when happens when a drop occurs. We can also add a DropHandler directly in the tree.
      options.setOnDrop(new DroppableFunction() {

        public void f(DragAndDropContext context) {
          //retrieve the Member data that was dropped
          MemberInfo droppedMember = context.getDraggableData();
          //retrieve the Permission where the member was dropped
          Permission dropPermission = context.getDroppableData();

          MemberDatabase.get().permissionChange(droppedMember, dropPermission);

        }
      });
      
      return permissionNodeInfo;

    } else if (value instanceof Permission) {
      // Permission Tree node. 
      Permission p = (Permission) value;
      
      //retrive all member having this permission
      ListDataProvider<MemberInfo> dataProvider = MemberDatabase.get()
          .getDataProvider(p);

      DragAndDropNodeInfo<MemberInfo> memberNodeInfo = new DragAndDropNodeInfo<MemberInfo>(dataProvider, memberCell, new SingleSelectionModel<MemberInfo>(),null);

      // member cell are only draggable
      memberNodeInfo.setCellDraggableOnly(); 

      // setup the drag operation
      DraggableOptions options = memberNodeInfo.getDraggableOptions();
      // opacity of the drag helper
      options.setOpacity((float) 0.9);
      // cursor during the drag operation
      options.setCursor(Cursor.MOVE);
      ...

      return memberNodeInfo;
    }

    String type = value.getClass().getName();
    throw new IllegalArgumentException("Unsupported object type: " + type);
  }

}}}
== !DragAndDropCellTable and !DragAndDropColumn classes ==

== ==

== Events ==

All DragAndDrop cell widgets propose a set of methods allowing the registration of handlers for all drag and drop events.
{{{

}}}

= Examples =
----
To illustrate what we talked in this article, example are available to : http://gwtquery-plugins.googlecode.com/svn/trunk/droppable/demo/GWTSimpleSample/GWTSimpleSample.html

All examples are tested on Internet explore 6, 7 and 8, Firefox 3.6, Google Chrome 4, Opera 10 and Safari 5. 

= Issues =
----
Although I spent much time to test the plugin, this one is not bug free guaranteed. If you found bugs, don't hesitate to open a issue to the [http://code.google.com/p/gwtquery-plugins/issues/entry issue tracker]. 